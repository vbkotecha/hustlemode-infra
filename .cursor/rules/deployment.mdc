---
description: "Azure Functions deployment configuration rules with exact resource names and commands for HustleMode.ai"
globs: "scripts/**/*,deployment-config.json,.github/workflows/**/*,DEPLOYMENT.md"
alwaysApply: false
---

# HustleMode.ai Supabase Deployment Rules

## âš ï¸ CRITICAL: Documentation Synchronization

**MANDATORY**: Any changes to deployment configuration MUST update both:
- `README.md` - Complete deployment guide with examples
- `deployment-config.json` - Authoritative configuration values

**These files must ALWAYS stay synchronized** to prevent deployment issues and configuration drift.

## ğŸ¯ Supabase Configuration (Authoritative Values)

### Project Configuration
- **Platform**: `Supabase Edge Functions`
- **Runtime**: `Deno/TypeScript`
- **Project Type**: `Edge Functions + PostgreSQL`
- **Region**: `us-east-1` (default)
- **Database**: `Supabase PostgreSQL with RLS`

### URLs (Production)
- **Base URL**: `https://your-project-ref.supabase.co/functions/v1`
- **Health Check**: `https://your-project-ref.supabase.co/functions/v1/health`
- **Chat API**: `https://your-project-ref.supabase.co/functions/v1/chat`
- **WhatsApp Webhook**: `https://your-project-ref.supabase.co/functions/v1/whatsapp`
- **Dashboard**: `https://supabase.com/dashboard/project/your-project-ref`

### Environment Configuration
- **Memory Provider**: `postgresql` (default) or `mem0`
- **AI Provider**: `Groq (Llama 3.1 70B)`
- **Database**: `Supabase PostgreSQL`
- **Authentication**: `Service Role Key`

## ğŸš€ Current Deployment Architecture

### Single-Command Deployment
```bash
# Deploy all functions
supabase functions deploy

# Deploy specific function
supabase functions deploy health
supabase functions deploy chat
supabase functions deploy whatsapp
```

### Deployment Requirements
- **Supabase CLI** installed and authenticated
- **Project linked** via `supabase link --project-ref your-project-ref`
- **Database schema** deployed via `supabase db reset --linked`
- **Environment variables** configured in Supabase Dashboard
- **TypeScript compilation** automatic (Deno runtime)

## ğŸ”§ TypeScript/Deno Requirements

### Project Structure Validation
```
supabase-edge-functions/
â”œâ”€â”€ functions/
â”‚   â”œâ”€â”€ health/index.ts
â”‚   â”œâ”€â”€ chat/index.ts
â”‚   â””â”€â”€ whatsapp/index.ts
â”œâ”€â”€ shared/
â”‚   â”œâ”€â”€ config.ts
â”‚   â”œâ”€â”€ database.ts
â”‚   â”œâ”€â”€ groq.ts
â”‚   â”œâ”€â”€ memory.ts
â”‚   â”œâ”€â”€ whatsapp.ts
â”‚   â””â”€â”€ utils.ts
â”œâ”€â”€ deno.json
â””â”€â”€ import_map.json
```

### Deployment Validation Rules
- âœ… All functions must use TypeScript
- âœ… Import maps defined in `import_map.json`
- âœ… Shared utilities in `shared/` directory
- âœ… Database schema matches PostgreSQL structure
- âŒ Never use Node.js specific imports
- âŒ Never deploy without type checking

## ğŸš¨ MANDATORY Documentation Sync Requirements

### ğŸ”„ Change Propagation Rules (ALWAYS REQUIRED)

#### Any deployment-config.json changes â†’ MUST UPDATE:
- âœ… **README.md**: All URLs, configuration values, and examples
- âœ… **Database schema**: Table structure and functions
- âœ… **Environment variables**: .env template and production config
- âœ… **This cursor rule**: If project configuration changes

#### Any database/supabase-schema.sql changes â†’ MUST UPDATE:
- âœ… **README.md**: Database schema section
- âœ… **deployment-config.json**: Database configuration
- âœ… **Memory service**: PostgreSQL provider implementation

#### Any README.md changes â†’ MUST UPDATE:
- âœ… **Last modified date**: Current date
- âœ… **deployment-config.json**: Verify all values match
- âœ… **Test all URLs**: Ensure curl commands work with current endpoints

### ğŸ“‹ Documentation Synchronization Checklist

Before committing ANY deployment changes:
- [ ] **README.md** reflects all current configuration values
- [ ] **deployment-config.json** contains authoritative source of truth
- [ ] **All URLs are identical** across all files (no placeholders)
- [ ] **Environment variables are current** in all examples
- [ ] **Dates are updated** to reflect modification time
- [ ] **All curl commands tested** and working
- [ ] **Memory provider configuration** is consistent

### Documentation Standards (STRICT REQUIREMENTS)
- **README.md**: Must reflect current Supabase Edge Functions architecture
- **deployment-config.json**: Must match Supabase Dashboard configuration exactly
- **All URLs**: Must be consistent across all files (zero tolerance for drift)
- **Dates**: Must be current (December 2024)
- **API Keys**: Must be properly templated (no real keys in repo)

## ğŸ”§ Deployment Methods

### Method 1: Supabase CLI (Recommended)
```bash
# Link to project
supabase link --project-ref your-project-ref

# Deploy database schema
supabase db reset --linked

# Deploy all functions
supabase functions deploy

# Deploy with environment file
supabase functions deploy --env-file .env
```

### Method 2: Individual Function Deployment
```bash
# Deploy specific functions
supabase functions deploy health
supabase functions deploy chat
supabase functions deploy whatsapp
```

### Method 3: Automated Script
```bash
./scripts/deploy-supabase.sh
```

## ğŸ—„ï¸ Database Deployment Requirements

### Schema Deployment (MANDATORY)
```bash
# Deploy schema first
supabase db reset --linked

# Verify tables created
supabase db ls
```

### Required Tables
- âœ… `users` - Core user data with phone number lookup
- âœ… `user_preferences` - AI personality and settings
- âœ… `conversation_memory` - Chat context (replaces Mem0)

### Security Requirements
- âœ… Row Level Security (RLS) enabled on all tables
- âœ… Service role key for Edge Functions
- âœ… Proper foreign key constraints
- âœ… Indexes for performance optimization

## ğŸ§  Memory Service Configuration

### PostgreSQL Provider (Default)
```bash
MEMORY_PROVIDER=postgresql
# Uses native Supabase PostgreSQL with full-text search
```

### Mem0 Provider (Optional)
```bash
MEMORY_PROVIDER=mem0
MEM0_API_KEY=m0-your-api-key
# Requires additional Mem0 Cloud subscription
```

### Switching Providers
- âœ… Change environment variable only
- âœ… No code changes required
- âœ… Automatic detection and routing
- âœ… Graceful fallback on errors

## ğŸš« Prohibited Patterns

### Never Do These:
- âŒ Use Azure Functions deployment commands
- âŒ Reference old Azure URLs or configurations
- âŒ Deploy without database schema first
- âŒ Use Node.js imports in Deno functions
- âŒ Store real API keys in version control
- âŒ Deploy without type checking

### Always Do These:
- âœ… Use `supabase functions deploy` for deployment
- âœ… Deploy database schema before functions
- âœ… Use TypeScript throughout codebase
- âœ… Test endpoints after deployment
- âœ… Keep memory provider abstraction
- âœ… Validate environment variables

## ğŸ¯ Quality Assurance

### ğŸš¨ BEFORE ANY DEPLOYMENT CHANGE - MANDATORY CHECKLIST:
1. **Documentation Sync**: Verify README.md and deployment-config.json are consistent
2. **URL Testing**: Test ALL documented URLs and endpoints work
3. **Database Schema**: Ensure database schema is deployed and up-to-date
4. **TypeScript Compilation**: Validate all functions compile without errors
5. **Environment Variables**: Verify all required variables are configured
6. **Memory Provider**: Test memory service functionality
7. **Function Keys**: Ensure service role key is properly configured

### ğŸš« DEPLOYMENT BLOCKERS:
- âŒ **Inconsistent URLs** between README.md and deployment-config.json
- âŒ **Missing database schema** deployment
- âŒ **TypeScript compilation errors** in any function
- âŒ **Missing environment variables** required for functionality
- âŒ **Outdated documentation** after configuration changes

## ğŸ”„ Migration Notes

### Migrated FROM Azure:
- âŒ Azure Functions (Python runtime)
- âŒ Azure OpenAI Service
- âŒ Azure PostgreSQL
- âŒ Function key authentication
- âŒ Complex GitHub Actions pipeline

### Migrated TO Supabase:
- âœ… Supabase Edge Functions (Deno/TypeScript)
- âœ… Groq API (Llama 3.1 70B)
- âœ… Supabase PostgreSQL
- âœ… Service role authentication
- âœ… Simple CLI deployment

## ğŸ“Š Performance Targets

### Deployment Metrics
- **Function Deployment**: <30 seconds
- **Database Schema**: <10 seconds
- **Cold Start**: <100ms
- **Response Time**: 200-500ms
- **Memory Operations**: <50ms

### Cost Optimization
- **Database**: Included with Supabase plan
- **Edge Functions**: Pay-per-invocation
- **Memory Service**: $0 (PostgreSQL) or $20-50/month (Mem0)
- **AI Inference**: $10-30/month (Groq pay-per-token)

---
**Purpose**: Single source of truth for Supabase deployment requirements
**Scope**: Configuration, documentation, deployment, and memory service architecture
**âš ï¸ CRITICAL**: README.md and deployment-config.json MUST stay synchronized at all times

---
**Purpose**: Single source of truth for all deployment requirements
**Scope**: Configuration, documentation, packaging, and pipeline architecture
**âš ï¸ CRITICAL**: DEPLOYMENT.md and deployment-config.json MUST stay synchronized at all times
