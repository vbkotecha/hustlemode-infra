# HustleMode.ai Supabase Deployment Rules

## üõ°Ô∏è CRITICAL: Quality Enforcement Integration

**MANDATORY**: ALL deployments MUST pass automated quality checks:
- `scripts/code-quality-check.sh` - Runs automatically before deployment
- Pre-commit hooks - Block commits with quality violations
- File size limits - No files over specified limits
- Zero duplication - Shared modules required for common code
- TypeScript validation - No compilation errors allowed
- Organization checks - Proper directory structure enforced

**Quality checks are AUTOMATICALLY INTEGRATED into all deployment scripts**

## üéØ Supabase Configuration (Authoritative Values)

### Project Configuration
- **Platform**: `Supabase Edge Functions`
- **Runtime**: `Deno/TypeScript`
- **Project Type**: `Edge Functions + PostgreSQL + Groq API`
- **Region**: `us-east-1` (default)
- **Database**: `Supabase PostgreSQL with RLS`
- **AI Provider**: `Groq (meta-llama/llama-4-maverick-17b-128e-instruct)`
- **Memory Provider**: `Mem0 Cloud API`

### URLs (Production)
- **Base URL**: `https://yzfclhnkxpgyxeklrvur.supabase.co/functions/v1`
- **Health Check**: `https://yzfclhnkxpgyxeklrvur.supabase.co/functions/v1/health`
- **Chat API**: `https://yzfclhnkxpgyxeklrvur.supabase.co/functions/v1/chat`
- **WhatsApp Webhook**: `https://yzfclhnkxpgyxeklrvur.supabase.co/functions/v1/whatsapp`
- **Dashboard**: `https://supabase.com/dashboard/project/yzfclhnkxpgyxeklrvur`

### Environment Configuration
- **Memory Provider**: `Mem0 Cloud API` (m0-px1OPjDmgZtUYoMwaNRUeGOL8nnoqT5zv8oUaDdj)
- **AI Provider**: `Groq (Llama 4 Maverick 17B)`
- **Database**: `Supabase PostgreSQL (yzfclhnkxpgyxeklrvur)`
- **Authentication**: `Service Role Key`

## üöÄ Quality-Enforced Deployment Architecture

### Automated Quality-Checked Deployment
```bash
# All deployments now include automatic quality checks
./scripts/deploy-supabase.sh
# ‚Üí Runs code-quality-check.sh automatically
# ‚Üí Blocks deployment if quality issues found

./scripts/deploy-migrations.sh
# ‚Üí Runs code-quality-check.sh automatically
# ‚Üí Validates file sizes, duplication, organization
```

### Individual Function Deployment (With Quality Checks)
```bash
# Quality checks integrated into all deployment paths
supabase functions deploy health    # ‚â§100 lines enforced
supabase functions deploy chat      # ‚â§100 lines enforced  
supabase functions deploy whatsapp  # ‚â§100 lines enforced
```

### Quality Gate Requirements (CANNOT BYPASS)
- **File Size Validation**: Edge functions ‚â§100 lines, shared modules ‚â§80 lines
- **Duplication Detection**: Zero tolerance for duplicate code
- **Organization Check**: Proper directory structure required
- **TypeScript Compilation**: All functions must compile without errors
- **Import Validation**: No circular dependencies allowed

## üîß Quality-Controlled Project Structure

### Enforced Structure (Validated Automatically)
```
supabase/
‚îú‚îÄ‚îÄ functions/
‚îÇ   ‚îú‚îÄ‚îÄ health/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ index.ts          # ‚â§100 lines - routing only
‚îÇ   ‚îú‚îÄ‚îÄ chat/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ index.ts          # ‚â§100 lines - routing only
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ handlers.ts       # ‚â§120 lines - business logic
‚îÇ   ‚îî‚îÄ‚îÄ whatsapp/
‚îÇ       ‚îú‚îÄ‚îÄ index.ts          # ‚â§100 lines - routing only
‚îÇ       ‚îî‚îÄ‚îÄ handlers.ts       # ‚â§120 lines - business logic
‚îú‚îÄ‚îÄ shared/
‚îÇ   ‚îú‚îÄ‚îÄ ai.ts                 # ‚â§80 lines - AI generation
‚îÇ   ‚îú‚îÄ‚îÄ users.ts              # ‚â§80 lines - user operations
‚îÇ   ‚îú‚îÄ‚îÄ config.ts             # ‚â§80 lines - configuration
‚îÇ   ‚îú‚îÄ‚îÄ database/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ index.ts          # ‚â§20 lines - exports only
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ client.ts         # ‚â§80 lines - client management
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ users.ts          # ‚â§80 lines - user operations
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ health.ts         # ‚â§80 lines - health checks
‚îÇ   ‚îî‚îÄ‚îÄ utils/
‚îÇ       ‚îú‚îÄ‚îÄ index.ts          # ‚â§20 lines - exports only
‚îÇ       ‚îú‚îÄ‚îÄ responses.ts      # ‚â§60 lines - response helpers
‚îÇ       ‚îú‚îÄ‚îÄ validation.ts     # ‚â§60 lines - validation logic
‚îÇ       ‚îú‚îÄ‚îÄ text.ts           # ‚â§60 lines - text processing
‚îÇ       ‚îî‚îÄ‚îÄ performance.ts    # ‚â§60 lines - performance monitoring
‚îú‚îÄ‚îÄ migrations/
‚îÇ   ‚îú‚îÄ‚îÄ 20241219_v1.0.0_baseline_schema.sql
‚îÇ   ‚îî‚îÄ‚îÄ README.md
‚îú‚îÄ‚îÄ deno.json
‚îî‚îÄ‚îÄ import_map.json
```

### Quality Validation Rules (AUTOMATICALLY ENFORCED)
- ‚úÖ All functions must use TypeScript with no compilation errors
- ‚úÖ File size limits strictly enforced (see limits above)
- ‚úÖ Zero code duplication tolerance
- ‚úÖ Shared utilities must be in appropriate directories
- ‚úÖ Database schema managed through migration system
- ‚úÖ Import maps defined in `import_map.json`
- ‚ùå Never exceed file size limits
- ‚ùå Never duplicate code between modules
- ‚ùå Never deploy without passing quality checks

## üö® MANDATORY Quality-Enhanced Documentation Sync

### üîÑ Change Propagation Rules (QUALITY-VALIDATED)

#### Any deployment-config.json changes ‚Üí MUST UPDATE:
- ‚úÖ **README.md**: All URLs, configuration values, and examples
- ‚úÖ **Database schema**: Table structure and functions  
- ‚úÖ **Environment variables**: .env template and production config
- ‚úÖ **Quality enforcement**: Update file size limits if needed
- ‚úÖ **This cursor rule**: If project configuration changes

#### Any database schema changes ‚Üí MUST UPDATE:
- ‚úÖ **README.md**: Database schema section
- ‚úÖ **deployment-config.json**: Database configuration
- ‚úÖ **Memory service**: Update user operations
- ‚úÖ **Migration system**: Create new versioned migration

#### Any code structure changes ‚Üí MUST UPDATE:
- ‚úÖ **Quality enforcement rules**: Update file organization checks
- ‚úÖ **Import maps**: Update module dependencies
- ‚úÖ **Documentation**: Reflect new module structure

### üìã Quality-Enhanced Documentation Checklist

Before committing ANY deployment changes:
- [ ] **Quality checks pass**: `./scripts/code-quality-check.sh` succeeds
- [ ] **File size compliance**: All files within specified limits
- [ ] **Zero duplication**: No duplicate code detected
- [ ] **README.md** reflects all current configuration values
- [ ] **deployment-config.json** contains authoritative source of truth
- [ ] **All URLs are identical** across all files (no placeholders)
- [ ] **Environment variables are current** in all examples
- [ ] **Migration system**: Database changes properly versioned
- [ ] **All curl commands tested** and working

## üîß Quality-Integrated Deployment Methods

### Method 1: Automated Quality-Checked Deployment (Recommended)
```bash
# Quality checks run automatically before deployment
./scripts/deploy-supabase.sh
# ‚Üí Code quality validation
# ‚Üí File size enforcement  
# ‚Üí Duplication detection
# ‚Üí TypeScript compilation
# ‚Üí Then deployment proceeds

# Migration deployment with quality checks
./scripts/deploy-migrations.sh
# ‚Üí Schema validation
# ‚Üí Quality enforcement
# ‚Üí Migration deployment
```

### Method 2: Manual with Quality Validation
```bash
# Run quality checks manually first
./scripts/code-quality-check.sh

# Then deploy if quality checks pass
supabase functions deploy
```

### Method 3: Development Quality Monitoring
```bash
# Daily quality monitoring
./scripts/daily-quality-report.sh

# Setup quality enforcement system
./scripts/setup-quality-enforcement.sh
```

## üóÑÔ∏è Migration-Managed Database Deployment

### Automated Migration System (QUALITY-VALIDATED)
```bash
# Create new migration (version-controlled)
./scripts/create-migration.sh "description of changes"

# Deploy migrations with quality checks
./scripts/deploy-migrations.sh
# ‚Üí Quality validation first
# ‚Üí Schema deployment
# ‚Üí Version tracking
```

### Required Tables (Schema v1.0.0)
- ‚úÖ `users` - Core user data with phone number lookup
- ‚úÖ `user_preferences` - AI personality and settings  
- ‚úÖ `schema_versions` - Migration tracking and versioning

### Quality-Enforced Security Requirements
- ‚úÖ Row Level Security (RLS) enabled on all tables
- ‚úÖ Service role key for Edge Functions
- ‚úÖ Proper foreign key constraints
- ‚úÖ Indexes for performance optimization
- ‚úÖ Phone number constraints with + prefix validation

## üß† Memory Service Configuration (Quality-Controlled)

### Mem0 Cloud Provider (Production)
```bash
MEMORY_PROVIDER=mem0
MEM0_API_KEY=m0-px1OPjDmgZtUYoMwaNRUeGOL8nnoqT5zv8oUaDdj
# Cloud-managed memory service with reliability guarantees
```

### Quality Requirements for Memory Operations
- ‚úÖ User ID (UUID) as universal identifier across platforms
- ‚úÖ Phone number lookup to find user_id
- ‚úÖ Shared memory across all AI personalities
- ‚úÖ Error handling for memory service failures
- ‚úÖ Performance monitoring for memory operations

## üö´ Prohibited Patterns (AUTOMATICALLY BLOCKED)

### Quality System Prevents These:
- ‚ùå **Files exceeding size limits** (automatically blocked)
- ‚ùå **Code duplication** (pre-commit hooks prevent)
- ‚ùå **Poor organization** (directory structure validated)
- ‚ùå **TypeScript errors** (compilation checked)
- ‚ùå **Deployment without quality checks** (integrated into scripts)

### Legacy Patterns No Longer Possible:
- ‚ùå Azure Functions deployment commands
- ‚ùå Giant files (371+ lines like old WhatsApp function)
- ‚ùå Copy-paste programming between modules
- ‚ùå Deployment without validation
- ‚ùå Manual schema management without versioning

### Quality-Enforced Best Practices:
- ‚úÖ Use `supabase functions deploy` for deployment
- ‚úÖ Deploy database schema through migration system
- ‚úÖ Keep all modules under size limits
- ‚úÖ Create shared utilities for common code
- ‚úÖ Pass quality checks before deployment
- ‚úÖ Maintain modular, testable architecture

## üéØ Quality Assurance Integration

### üö® AUTOMATED QUALITY GATES (CANNOT BYPASS):
1. **Pre-Commit Hook**: Quality checks run automatically before every commit
2. **Pre-Deploy Validation**: Quality checks integrated into all deployment scripts
3. **File Size Enforcement**: Oversized files blocked immediately
4. **Duplication Prevention**: Copy-paste code blocked at commit time
5. **TypeScript Validation**: Compilation errors prevent deployment
6. **Organization Checks**: Directory structure validated automatically

### üö´ AUTOMATIC DEPLOYMENT BLOCKERS:
- ‚ùå **File size violations** (Edge functions >100 lines, modules >80 lines)
- ‚ùå **Code duplication detected** (shared modules required)
- ‚ùå **TypeScript compilation errors** in any function
- ‚ùå **Improper file organization** (wrong directory structure)
- ‚ùå **Missing migration versioning** for schema changes

### üìä Quality Monitoring Dashboard
```bash
# Daily quality score tracking
./scripts/daily-quality-report.sh
# ‚Üí File size compliance: 95%
# ‚Üí Code duplication: 0%
# ‚Üí TypeScript: 100%
# ‚Üí Organization: 100%
# ‚Üí Overall Score: 97%
```

## üîÑ Migration Notes (Quality System Added)

### Migrated FROM (Technical Debt):
- ‚ùå Azure Functions (slow, complex deployment)
- ‚ùå Giant files (371 lines WhatsApp function)
- ‚ùå Code duplication (AI logic copied between functions)
- ‚ùå Manual deployments without validation
- ‚ùå No quality enforcement

### Migrated TO (Quality-Enforced):
- ‚úÖ Supabase Edge Functions (fast, simple deployment)
- ‚úÖ Modular architecture (all files <100 lines)
- ‚úÖ Shared modules (zero duplication)
- ‚úÖ Automated quality-checked deployments
- ‚úÖ Permanent quality enforcement system

## üìä Quality-Enhanced Performance Targets

### Deployment Metrics (Quality-Validated)
- **Quality Check**: <10 seconds
- **Function Deployment**: <30 seconds
- **Database Migration**: <10 seconds
- **Cold Start**: <50ms (Supabase Edge Functions)
- **Response Time**: 200-500ms
- **Memory Operations**: <50ms (Mem0 Cloud)

### Quality Metrics (Continuously Monitored)
- **File Size Compliance**: >95%
- **Code Duplication**: 0%
- **Test Coverage**: >80%
- **TypeScript Compilation**: 100%
- **Architecture Adherence**: 100%

### Cost Optimization (Quality-Controlled)
- **Database**: $0-25/month (Supabase Pro plan)
- **Edge Functions**: $0-10/month (pay-per-invocation)
- **Memory Service**: $20-50/month (Mem0 Cloud)
- **AI Inference**: $10-30/month (Groq pay-per-token)
- **Quality System**: $0 (automated scripts)

---
**Purpose**: Quality-enforced deployment system ensuring permanent code excellence
**Scope**: Configuration, quality enforcement, deployment automation, and architecture maintenance
**‚ö†Ô∏è CRITICAL**: Quality checks are MANDATORY and CANNOT be bypassed without explicit override

---
**Purpose**: Single source of truth for all deployment requirements
**Scope**: Configuration, documentation, packaging, and pipeline architecture
**‚ö†Ô∏è CRITICAL**: DEPLOYMENT.md and deployment-config.json MUST stay synchronized at all times
