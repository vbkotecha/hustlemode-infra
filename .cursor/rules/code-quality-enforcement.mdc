# Code Quality Enforcement Rules - AUTOMATED PREVENTION

## ğŸš« CRITICAL: File Size Limits (STRICTLY ENFORCED)

### Maximum File Size Limits
- **Edge Functions**: 100 lines maximum per index.ts file
- **Shared Modules**: 80 lines maximum per module file
- **Handler Files**: 120 lines maximum
- **Utility Files**: 60 lines maximum per module
- **Type Files**: 200 lines maximum (types can be longer)

### AUTOMATED ENFORCEMENT
```bash
# Before ANY commit - check file sizes automatically
find supabase/functions -name "index.ts" -exec wc -l {} \; | awk '$1 > 100 {print "âŒ VIOLATION: " $2 " has " $1 " lines (max 100)"}'
find supabase/shared -name "*.ts" -not -path "*/types.ts" -exec wc -l {} \; | awk '$1 > 80 {print "âŒ VIOLATION: " $2 " has " $1 " lines (max 80)"}'
```

### MANDATORY REFACTORING TRIGGERS
- **Any file >100 lines**: IMMEDIATE refactoring required
- **Any function >50 lines**: Extract to separate module
- **Any class >80 lines**: Split into multiple classes
- **Duplicate code >5 lines**: Create shared module

## ğŸ”„ DUPLICATION PREVENTION (ZERO TOLERANCE)

### PROHIBITED PATTERNS
- âŒ **Same function in 2+ files** - Must extract to shared module
- âŒ **Copy-paste code blocks** - Must create reusable utility
- âŒ **Duplicate API calls** - Must use shared service
- âŒ **Repeated validation logic** - Must use shared validators
- âŒ **Multiple DB queries for same data** - Must use shared data layer

### DETECTION RULES
```bash
# Detect potential duplication
grep -r "async function" supabase/ | cut -d: -f2 | sort | uniq -d
grep -r "export function" supabase/ | cut -d: -f2 | sort | uniq -d
```

### ENFORCEMENT ACTIONS
1. **Pre-commit Hook**: Automatically detect duplication
2. **Code Review Blocker**: Cannot merge with duplication
3. **Automated Refactoring**: Suggest shared module creation
4. **Documentation Update**: Auto-update module dependency graph

## ğŸ“ MANDATORY FILE ORGANIZATION

### Directory Structure (ENFORCED)
```
supabase/
â”œâ”€â”€ functions/
â”‚   â”œâ”€â”€ [function-name]/
â”‚   â”‚   â”œâ”€â”€ index.ts          # â‰¤100 lines - routing only
â”‚   â”‚   â”œâ”€â”€ handlers.ts       # â‰¤120 lines - business logic
â”‚   â”‚   â””â”€â”€ types.ts          # â‰¤50 lines - function-specific types
â”œâ”€â”€ shared/
â”‚   â”œâ”€â”€ [domain]/             # Domain-specific modules
â”‚   â”‚   â”œâ”€â”€ index.ts          # â‰¤20 lines - exports only
â”‚   â”‚   â”œâ”€â”€ [module].ts       # â‰¤80 lines - single responsibility
â”‚   â”‚   â””â”€â”€ types.ts          # â‰¤100 lines - domain types
â”‚   â””â”€â”€ utils/                # Cross-cutting utilities
â”‚       â”œâ”€â”€ index.ts          # â‰¤20 lines - exports only
â”‚       â””â”€â”€ [utility].ts      # â‰¤60 lines - single utility
```

### PROHIBITED STRUCTURES
- âŒ **Files directly in functions/ root** (except deno.json, import_map.json)
- âŒ **Giant shared files** without domain organization
- âŒ **Utils dumping ground** - must be categorized
- âŒ **Mixed concerns** in single files
- âŒ **Circular dependencies** between modules

## ğŸ§ª TESTING REQUIREMENTS (MANDATORY)

### Testing Rules
- **Every shared module** MUST have unit tests
- **Every handler** MUST have integration tests
- **Every API endpoint** MUST have end-to-end tests
- **Test coverage** MUST be >80% for shared modules

### Test File Organization
```
tests/
â”œâ”€â”€ unit/
â”‚   â”œâ”€â”€ shared/
â”‚   â”‚   â”œâ”€â”€ ai.test.ts        # Test shared/ai.ts
â”‚   â”‚   â”œâ”€â”€ users.test.ts     # Test shared/users.ts
â”‚   â”‚   â””â”€â”€ utils/
â”‚   â”‚       â””â”€â”€ validation.test.ts
â”œâ”€â”€ integration/
â”‚   â”œâ”€â”€ functions/
â”‚   â”‚   â”œâ”€â”€ chat.test.ts      # Test chat function
â”‚   â”‚   â””â”€â”€ whatsapp.test.ts  # Test whatsapp function
â””â”€â”€ e2e/
    â”œâ”€â”€ chat-api.test.ts
    â””â”€â”€ whatsapp-webhook.test.ts
```

## ğŸš¨ QUALITY GATES (AUTOMATED BLOCKERS)

### Pre-Commit Checks (CANNOT BYPASS)
1. **File Size Validation**: Block commits with oversized files
2. **Duplication Detection**: Block commits with duplicate code
3. **Import Cycle Detection**: Block circular dependencies
4. **TypeScript Compilation**: Block commits with TS errors
5. **Test Coverage**: Block commits that reduce coverage

### Pre-Deploy Checks (CANNOT BYPASS)
1. **All Tests Pass**: 100% pass rate required
2. **Performance Benchmarks**: Response times within limits
3. **Security Scan**: No security vulnerabilities
4. **Dependency Audit**: No vulnerable dependencies
5. **Documentation Updated**: README and docs current

## ğŸ”§ DEVELOPMENT WORKFLOW (ENFORCED)

### MANDATORY Process for New Features
1. **Design Review**: Architecture approval before coding
2. **Module Planning**: Determine which shared modules to use/create
3. **Test-First**: Write tests before implementation
4. **Single Responsibility**: Each new file has one clear purpose
5. **Integration Testing**: Verify with existing modules
6. **Documentation**: Update module dependency graph

### PROHIBITED Shortcuts
- âŒ **Adding to existing large files** - Must create new focused modules
- âŒ **Copy-paste fixes** - Must refactor to shared solution
- âŒ **Quick hacks** - Must follow established patterns
- âŒ **Skipping tests** - Tests are mandatory for all shared code
- âŒ **Breaking interfaces** - Must maintain backward compatibility

## ğŸ“Š MONITORING & ALERTS

### Automated Quality Monitoring
```bash
#!/bin/bash
# Daily code quality report
echo "ğŸ“Š DAILY CODE QUALITY REPORT"
echo "=============================="

# File size violations
echo "ğŸ“ File Size Violations:"
find supabase -name "*.ts" -exec wc -l {} \; | awk '$1 > 100 {violations++} END {print violations ? violations " files over limit" : "âœ… All files within limits"}'

# Duplication detection
echo "ğŸ”„ Potential Duplications:"
# Add duplication detection logic

# Test coverage
echo "ğŸ§ª Test Coverage:"
# Add coverage report

# Performance metrics
echo "âš¡ Performance Metrics:"
# Add performance monitoring
```

### Alert Triggers
- **File size violation**: Immediate Slack alert
- **Duplication detected**: Block PR with explanation
- **Test coverage drop**: Require explanation and remediation
- **Performance regression**: Require optimization plan

## ğŸ›¡ï¸ AUTOMATED REMEDIATION

### Self-Healing Actions
1. **Auto-format**: Code automatically formatted on save
2. **Import Organization**: Automatically organize and remove unused imports
3. **Type Generation**: Auto-generate types from database schema
4. **Documentation Sync**: Auto-update module dependency documentation

### Suggested Refactoring
- **File too large**: Suggest specific modules to extract
- **Duplication detected**: Suggest shared module creation
- **Complex function**: Suggest breakdown strategy
- **Performance issue**: Suggest optimization approach

## ğŸ“‹ CODE REVIEW CHECKLIST (MANDATORY)

### Reviewer Requirements
- [ ] **File sizes within limits** (automated check)
- [ ] **No code duplication** (automated check)
- [ ] **Single responsibility principle** followed
- [ ] **Proper error handling** implemented
- [ ] **Tests added/updated** for changes
- [ ] **Documentation updated** if needed
- [ ] **Performance impact** considered
- [ ] **Security implications** reviewed

### BLOCKING Issues (Cannot Merge)
- âŒ **File size violations**
- âŒ **Code duplication**
- âŒ **Missing tests for shared code**
- âŒ **TypeScript errors**
- âŒ **Security vulnerabilities**
- âŒ **Performance regressions**

## ğŸ¯ SUCCESS METRICS

### Daily Tracking
- **Average file size**: Must stay <80 lines
- **Duplication ratio**: Must stay at 0%
- **Test coverage**: Must stay >80%
- **Build time**: Must stay <30 seconds
- **Function response time**: Must stay <500ms

### Weekly Review
- **Code quality score**: Composite metric
- **Technical debt accumulation**: Lines of debt added
- **Refactoring efficiency**: Time to clean up violations
- **Developer satisfaction**: Team feedback on maintainability

---
**Core Principle**: Automated prevention is better than manual correction. These rules make it IMPOSSIBLE to create messy code.
description:
globs:
alwaysApply: false
---
